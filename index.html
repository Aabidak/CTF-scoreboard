<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CTF Flag Submission</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { 
    margin:0;
    padding:30px; 
    font-family:"Courier New", monospace;
    display:flex; flex-direction:column; align-items:center; 
    background:#000; color:#0ff; overflow-x:hidden;
  }

  /* Blinking star background using canvas */
  canvas#stars { 
    position:fixed; 
    top:0; left:0; width:100%; height:100%; 
    z-index:-1; 
    background:#000;
  }

  /* Creator neon light top-left */
  #creator {
    position:absolute; top:10px; left:10px;
    font-size:16px; color:#fff;
    text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #fff;
    opacity:1;
  }

  @keyframes flicker {
    0%,100% { opacity: 1; }
    10% { opacity: 0.2; }
    20% { opacity: 0.8; }
    30% { opacity: 0.2; }
    40% { opacity: 0.9; }
    50% { opacity: 0.3; }
    60% { opacity: 1; }
    70% { opacity: 0.2; }
    80% { opacity: 0.8; }
    90% { opacity: 0.2; }
  }

  /* Headers */
  h1,h2,h3 { text-align:center; color:#ff69b4; } 
  h2 { font-size:1.5em; } 
  h3 { font-size:1.2em; }

  /* Inputs & Buttons */
  input, button { 
    font-size:18px; margin:10px; padding:10px; border:1px solid #0ff; 
    background:#111; color:#0ff; border-radius:10px; 
  }
  button { cursor:pointer; font-weight:700; }

  #flag-section { margin-top:30px; width:min(520px,92vw); }

  /* Scoreboard */
  #scoreboard { 
    margin-top:20px; list-style:none; padding:0; width:min(420px,92vw); 
    max-height:400px; overflow-y:auto; 
  }
  #scoreboard li { padding:6px 0; border-bottom:1px solid cyan; color:#ff69b4; transition:all 0.5s ease; }
  #scoreboard li.top { color: gold; font-weight:bold; }
  #scoreboard li.new { background:rgba(0,255,255,0.2); }

  /* Navigation */
  #nav { position:absolute; top:10px; right:20px; }
  #nav a { margin-left:20px; color:#0ff; text-decoration:none; font-weight:bold; }

</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = { apiKey:"AIzaSyCkblbbA7iZmiGr617-KZB8Yd3H3a2Aq4M", authDomain:"ctfscoreboard-3af1b.firebaseapp.com", projectId:"ctfscoreboard-3af1b" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

let currentUser = null;
onAuthStateChanged(auth, (u) => {
  if(!u || !u.email || !u.email.endsWith("@player.local")) { window.location.href="login.html"; return; }
  currentUser = u;
  document.getElementById('nickname-display').textContent = u.displayName || (u.email.split("@")[0]);
  loadScores();
});

window.logout = async function(){
  await signOut(auth);
  window.location.href="login.html";
};

window.submitFlag = async function() {
  if(!currentUser){ alert("Not logged in"); return; }
  const challenge = document.getElementById('challenge').value.trim();
  const flagInput = document.getElementById('flag').value.trim();
  if(!challenge || !flagInput){ alert("Both fields required"); return; }

  try {
    const q1 = query(collection(db,"challenges"), where("name","==",challenge));
    const snap = await getDocs(q1);
    if (snap.empty){ alert("‚ùå Challenge not found"); return; }
    const docData = snap.docs[0].data();
    const hash = await sha256(flagInput);
    if (hash !== (docData.flagHash || "")){ alert("‚ùå Wrong flag!"); return; }

    const prev = await getDocs(query(collection(db,"scores"), where("uid","==",currentUser.uid), where("challenge","==",challenge)));
    if(!prev.empty){ alert("‚ö† Already submitted"); return; }

    const pts = docData.points || 100;
    await addDoc(collection(db,"scores"), {
      uid: currentUser.uid,
      nickname: currentUser.displayName || (currentUser.email.split("@")[0]),
      challenge, points: pts, timestamp: new Date()
    });
    alert("‚úÖ Correct! +" + pts + " pts");
    loadScores(challenge);
  } catch(e){ alert("Error: "+e.message); }

  document.getElementById('challenge').value="";
  document.getElementById('flag').value="";
};

async function loadScores(newChallenge=null){
  const ul = document.getElementById('scoreboard'); 
  ul.innerHTML='';
  const snap = await getDocs(query(collection(db,"scores"), orderBy("timestamp","asc")));
  const scores = {};
  snap.forEach(doc=>{ const d=doc.data(); scores[d.nickname]=(scores[d.nickname]||0)+d.points; });

  const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
  sorted.forEach(([nick,pts],idx)=>{
    const li = document.createElement('li'); 
    li.textContent = `${idx+1}. ${nick} : ${pts} pts`;
    if(idx===0) li.classList.add('top');
    if(currentUser && nick===(currentUser.displayName || (currentUser.email.split("@")[0])) && newChallenge) li.classList.add('new');
    ul.appendChild(li);
    if(currentUser && nick===(currentUser.displayName || (currentUser.email.split("@")[0])) && newChallenge) setTimeout(()=>li.classList.remove('new'),1500);
  });
}

// Neon flicker for creator
setTimeout(() => { document.getElementById('creator').style.animation = "flicker 1.5s infinite"; }, 2000);

// Star background canvas
window.onload = function() {
  const canvas = document.createElement('canvas');
  canvas.id='stars';
  document.body.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  let w=canvas.width=window.innerWidth;
  let h=canvas.height=window.innerHeight;

  const stars = [];
  for(let i=0;i<200;i++){
    stars.push({x:Math.random()*w, y:Math.random()*h, r:Math.random()*1.5, blink:Math.random()});
  }

  function animate(){
    ctx.clearRect(0,0,w,h);
    for(let s of stars){
      s.blink += 0.02;
      const alpha = 0.5 + 0.5*Math.sin(s.blink*2*Math.PI);
      ctx.fillStyle=`rgba(255,255,255,${alpha})`;
      ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,2*Math.PI); ctx.fill();
    }
    requestAnimationFrame(animate);
  }
  animate();
  window.addEventListener('resize',()=>{ w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; });
};

</script>
</head>
<body>
<div id="creator">By Cybe3MaF1a</div>

<div id="nav">
  <a href="leaderboard.html">Leaderboard</a>
  <a href="user.html">Profile</a>
  <a href="#" onclick="logout()">Logout</a>
</div>

<h1>üî• CTF Flag Submission</h1>
<h3>Welcome: <span id="nickname-display"></span></h3>

<div id="flag-section">
  <h2>Submit a Flag</h2>
  <input id="challenge" placeholder="Challenge Name"><br>
  <input id="flag" placeholder="Flag"><br>
  <button onclick="submitFlag()">Submit</button>
</div>

<h2>üèÜ Live Scoreboard</h2>
<ul id="scoreboard"></ul>
</body>
</html>

