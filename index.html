<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CTF Flag Submission</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: "Courier New", monospace;
    color: #0ff;
    text-align: center;
    overflow: hidden;
  }

  /* Canvas for stars */
  #starfield {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 0;
    background: #000;
  }

  /* Keep content above canvas */
  #content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 30px;
  }

  h1 { font-size: 3rem; color: #f0f; text-shadow: 0 0 15px #f0f; margin-bottom: 10px; }
  h2 { font-size: 2.2rem; color: #f0f; margin: 20px 0 10px 0; }
  h3 { font-size: 1.8rem; color: #f0f; margin-bottom: 20px; }

  input, button { 
    font-size: 20px; 
    margin: 10px; 
    padding: 12px 20px; 
    border: 1px solid #0ff; 
    background: rgba(17,17,17,0.85); 
    color: #0ff; 
    border-radius: 10px; 
    text-align: center;
  }

  button { cursor: pointer; font-weight: 700; }

  #flag-section { width: min(520px, 92vw); display: flex; flex-direction: column; align-items: center; }
  #scoreboard { margin-top: 20px; list-style: none; padding: 0; width: min(420px, 92vw); text-align: center; }
  #scoreboard li { padding: 10px 0; border-bottom: 1px solid #0ff; font-size: 1.3rem; transition: all 0.5s ease; }
  #scoreboard li.top { color: gold; font-weight: bold; }
  #scoreboard li.new { background: rgba(0,255,255,0.2); }

  #nav { position: absolute; top: 10px; width: 100%; text-align: center; z-index: 1; }
  #nav a { margin: 0 20px; color: #f0f; text-decoration: none; font-weight: bold; font-size: 1.2rem; }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = { apiKey:"AIzaSyCkblbbA7iZmiGr617-KZB8Yd3H3a2Aq4M", authDomain:"ctfscoreboard-3af1b.firebaseapp.com", projectId:"ctfscoreboard-3af1b" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

let currentUser = null;
onAuthStateChanged(auth, (u) => {
  if(!u || !u.email || !u.email.endsWith("@player.local")) { window.location.href="login.html"; return; }
  currentUser = u;
  document.getElementById('nickname-display').textContent = u.displayName || (u.email.split("@")[0]);
  loadScores();
});

window.logout = async function(){
  await signOut(auth);
  window.location.href="login.html";
};

window.submitFlag = async function() {
  if(!currentUser){ alert("Not logged in"); return; }
  const challenge = document.getElementById('challenge').value.trim();
  const flagInput = document.getElementById('flag').value.trim();
  if(!challenge || !flagInput){ alert("Both fields required"); return; }

  try {
    const q1 = query(collection(db,"challenges"), where("name","==",challenge));
    const snap = await getDocs(q1);
    if (snap.empty){ alert("‚ùå Challenge not found"); return; }
    const docData = snap.docs[0].data();
    const hash = await sha256(flagInput);
    if (hash !== (docData.flagHash || "")){ alert("‚ùå Wrong flag!"); return; }

    const prev = await getDocs(query(collection(db,"scores"), where("uid","==",currentUser.uid), where("challenge","==",challenge)));
    if(!prev.empty){ alert("‚ö† Already submitted"); return; }

    const pts = docData.points || 100;
    await addDoc(collection(db,"scores"), {
      uid: currentUser.uid,
      nickname: currentUser.displayName || (currentUser.email.split("@")[0]),
      challenge, points: pts, timestamp: new Date()
    });
    alert("‚úÖ Correct! +" + pts + " pts");
    loadScores(challenge);
  } catch(e){ alert("Error: "+e.message); }

  document.getElementById('challenge').value="";
  document.getElementById('flag').value="";
};

async function loadScores(newChallenge=null){
  const ul = document.getElementById('scoreboard'); 
  ul.innerHTML='';
  const snap = await getDocs(query(collection(db,"scores"), orderBy("timestamp","asc")));
  const scores = {};
  snap.forEach(doc=>{ const d=doc.data(); scores[d.nickname]=(scores[d.nickname]||0)+d.points; });

  const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
  sorted.forEach(([nick,pts],idx)=>{
    const li = document.createElement('li'); 
    li.textContent = `${idx+1}. ${nick} : ${pts} pts`;
    if(idx===0) li.classList.add('top');
    if(currentUser && nick===(currentUser.displayName || (currentUser.email.split("@")[0])) && newChallenge) li.classList.add('new');
    ul.appendChild(li);
    if(currentUser && nick===(currentUser.displayName || (currentUser.email.split("@")[0])) && newChallenge) setTimeout(()=>li.classList.remove('new'),1500);
  });
}
</script>
</head>
<body>
<canvas id="starfield"></canvas>
<div id="content">
  <div id="nav">
    <a href="leaderboard.html">Leaderboard</a>
    <a href="user.html">Profile</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
  <h1>üî• CTF Flag Submission</h1>
  <h3>Welcome: <span id="nickname-display"></span></h3>
  <div id="flag-section">
    <h2>Submit a Flag</h2>
    <input id="challenge" placeholder="Challenge Name"><br>
    <input id="flag" placeholder="Flag"><br>
    <button onclick="submitFlag()">Submit</button>
  </div>
  <h2>üèÜ Live Scoreboard</h2>
  <ul id="scoreboard"></ul>
</div>

<script>
// Starfield and comet animation
const canvas = document.getElementById('starfield');
const ctx = canvas.getContext('2d');
let width = canvas.width = window.innerWidth;
let height = canvas.height = window.innerHeight;

window.addEventListener('resize', () => {
  width = canvas.width = window.innerWidth;
  height = canvas.height = window.innerHeight;
});

const stars = [];
const numStars = 200;

// Create stars
for(let i=0;i<numStars;i++){
  stars.push({
    x: Math.random()*width,
    y: Math.random()*height,
    r: Math.random()*1.5,
    opacity: Math.random()
  });
}

let comet = { x:-50, y:Math.random()*height/2, len:150, speed:10, active:false, timer:0 };

// Draw loop
function animate(){
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,width,height);

  // Draw stars
  for(let s of stars){
    s.opacity += (Math.random()-0.5)*0.05;
    if(s.opacity < 0) s.opacity=0;
    if(s.opacity > 1) s.opacity=1;
    ctx.beginPath();
    ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
    ctx.fillStyle = `rgba(255,255,255,${s.opacity})`;
    ctx.fill();
  }

  // Comet logic
  comet.timer += 1;
  if(comet.timer > 240){ // ~4 seconds at 60fps
    comet.active = true;
    comet.x = -50;
    comet.y = Math.random()*height/2;
    comet.timer = 0;
  }
  if(comet.active){
    ctx.strokeStyle = 'rgba(255,255,255,0.8)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(comet.x, comet.y);
    ctx.lineTo(comet.x - comet.len, comet.y + comet.len*0.2);
    ctx.stroke();
    comet.x += comet.speed;
    if(comet.x - comet.len > width) comet.active = false;
  }

  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
