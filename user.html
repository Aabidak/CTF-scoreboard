<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CTF User Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: "Courier New", monospace;
    color: #0ff;
    background: black;
    overflow-y: auto;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #nav {
    position: absolute;
    top: 10px;
    right: 20px;
    z-index: 2;
  }
  #nav a {
    margin-left: 20px;
    color: #f0f;
    text-decoration: none;
    font-weight: bold;
  }

  h1 {
    text-align: center;
    color: #f0f;
    margin-top: 60px;
  }

  #stats {
    max-width: 900px;
    width: 90%;
    margin-top: 20px;
    overflow-y: auto;
    font-size: 20px;
  }

  .challenge {
    display: flex;
    justify-content: space-between;
    padding: 6px 12px;
    border-bottom: 1px solid #0ff;
  }

  .challenge-name { flex: 2; }
  .challenge-points { flex: 1; text-align: center; }
  .challenge-success { flex: 1; text-align: center; }
  .challenge-failed { flex: 1; text-align: center; }

  #overall {
    margin-top: 20px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
  }

  canvas#stars {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
  }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = { apiKey:"AIzaSyCkblbbA7iZmiGr617-KZB8Yd3H3a2Aq4M", authDomain:"ctfscoreboard-3af1b.firebaseapp.com", projectId:"ctfscoreboard-3af1b" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
onAuthStateChanged(auth, (u)=>{
  if(!u || !u.email.endsWith("@player.local")) window.location.href="login.html";
  currentUser = u;
  loadProfile();
});

window.logout = async function() {
  await signOut(auth);
  window.location.href="login.html";
}

async function loadProfile(){
  if(!currentUser) return;
  const snap = await getDocs(collection(db,"scores"));
  const challenges = {};
  snap.forEach(doc => {
    const d = doc.data();
    if(d.uid === currentUser.uid){
      if(!challenges[d.challenge]){
        challenges[d.challenge] = { points:0, success:0, failed:0 };
      }
      challenges[d.challenge].points += d.points;
      if(d.points>0) challenges[d.challenge].success += 1;
      else challenges[d.challenge].failed += 1;
    }
  });

  const statsDiv = document.getElementById('stats');
  statsDiv.innerHTML = '';
  let totalPoints = 0, totalAttempts = 0, totalFails = 0;

  for(const [name, data] of Object.entries(challenges)){
    totalPoints += data.points;
    totalAttempts += data.success;
    totalFails += data.failed;

    const div = document.createElement('div');
    div.className = 'challenge';
    div.innerHTML = `
      <div class="challenge-name">${name}</div>
      <div class="challenge-points">${data.points}</div>
      <div class="challenge-success">${((data.success/(data.success+data.failed))*100).toFixed(1)}%</div>
      <div class="challenge-failed">${data.failed}</div>
    `;
    statsDiv.appendChild(div);
  }

  const overallDiv = document.createElement('div');
  overallDiv.id = 'overall';
  const successRate = totalAttempts+totalFails>0 ? ((totalAttempts/(totalAttempts+totalFails))*100).toFixed(2) : 0;
  overallDiv.textContent = `Total Points: ${totalPoints} | Success Rate: ${successRate}% | Failed Attempts: ${totalFails}`;
  statsDiv.appendChild(overallDiv);
}

// Starfield background
window.onload = function(){
  const canvas = document.createElement('canvas');
  canvas.id = 'stars';
  document.body.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const stars = [];
  for(let i=0;i<150;i++){
    stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*1.5, opacity:Math.random()});
  }

  function draw(){
    ctx.fillStyle='black';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    for(let s of stars){
      ctx.beginPath();
      ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle=`rgba(255,255,255,${s.opacity})`;
      ctx.fill();
      s.opacity += (Math.random()-0.5)*0.05;
      if(s.opacity<0) s.opacity=0;
      if(s.opacity>1) s.opacity=1;
    }
    requestAnimationFrame(draw);
  }
  draw();
}
</script>
</head>
<body>
<div id="nav">
  <a href="index.html">Submit Flag</a>
  <a href="leaderboard.html">Leaderboard</a>
  <a href="#" onclick="logout()">Logout</a>
</div>

<h1>User Profile</h1>
<div id="stats"></div>
</body>
</html>
